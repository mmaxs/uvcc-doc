<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>uvcc: tee</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="Doxystyle-1.8.13.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">uvcc
   </div>
   <div id="projectbrief">libuv C++ bindings</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('doxy_page__example_tee.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">tee </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A full-fledged simple program that copies its <code>stdin</code> to <code>stdout</code> and also to each file specified as a program argument.</p>
<p>It demonstrates the following points:</p>
<ol type="1">
<li>Different I/O endpoints and common input/output operations for them can be handled in a generic uniform manner. The program can deal with <code>stdin</code>, <code>stdout</code> handles that can be system descriptors of any sort of supported I/O endpoints: a file, TCP/UDP socket, pipe, or TTY. Minimal changes relative to the previous example for <em>cpio</em> program need to be made in source code to get a full-fledged application.</li>
<li>The very same uvcc buffer can be easily dispatched to several asynchronous operations and its lifetime will continue until the last operation has completed.</li>
<li>An example for a simple version of the buffer pool implementation. The pool helps avoid intense memory allocation requests. Note that it may actually decrease the performance. The provided simple implementation is an auto-growing pool that is not thread-safe, so either only one dedicated thread might acquire an item from the pool in multi-thread environment or such acquire requests from different threads shall not interleave with each other. As far as this program is a typical single-thread libuv application these requirements are fulfilled. The condition of item's <code>(nrefs() == 1)</code> indicates that no more references are left anywhere at the runtime other than in the pool container itself and thus this spare item can be returned on an acquire request.</li>
</ol>
<p>In debug build some diagnostic messages are printed out.</p>
<dl class="section see"><dt>See also</dt><dd><em>stackoverflow.com</em>: <a href="http://stackoverflow.com/questions/28511541/libuv-allocated-memory-buffers-re-use-techniques">"libuv allocated memory buffers re-use techniques"</a></dd></dl>
<pre class="fragment">example/tee1.cpp </pre> <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &quot;uvcc.hpp&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#include &lt;cstdio&gt;</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &lt;cinttypes&gt;</span>  <span class="comment">// PRI*</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &lt;vector&gt;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &lt;fcntl.h&gt;</span>    <span class="comment">// O_*</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#ifndef _WIN32</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &lt;signal.h&gt;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;sighandler_t sigpipe_handler = <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/utility/program/signal.html">signal</a>(SIGPIPE, SIG_IGN);  <span class="comment">// ignore SIGPIPE</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifndef NDEBUG</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#define DEBUG_LOG(condition, format, ...)  do {\</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">    if ((condition))\</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">    {\</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">      fflush(stdout);\</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">      fprintf(stderr, (format), ##__VA_ARGS__);\</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">      fflush(stderr);\</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">    }\</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">} while (0)</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#define DEBUG_LOG(condition, ...)  (void)(condition)</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#define PRINT_UV_ERR(code, printf_args...)  do {\</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">  fflush(stdout);\</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">  fprintf(stderr, &quot;&quot; printf_args);\</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">  fprintf(stderr, &quot;: %s (%i): %s\n&quot;, ::uv_err_name(code), (int)(code), ::uv_strerror(code));\</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">  fflush(stderr);\</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">} while (0)</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<a class="code" href="classuv_1_1io.html">uv::io</a> in = <a class="code" href="classuv_1_1io.html#a5175d7718efde0459884902558816394">uv::io::guess_handle</a>(<a class="code" href="classuv_1_1loop.html#a465f36947090c922c69611e2a18428ea">uv::loop::Default</a>(), fileno(stdin)),</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;       out = <a class="code" href="classuv_1_1io.html#a5175d7718efde0459884902558816394">uv::io::guess_handle</a>(<a class="code" href="classuv_1_1loop.html#a465f36947090c922c69611e2a18428ea">uv::loop::Default</a>(), fileno(stdout));</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;constexpr <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> BUFFER_SIZE = 8192;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;constexpr <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> WRITE_QUEUE_SIZE_UPPER_LIMIT = 128*BUFFER_SIZE,</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;                      WRITE_QUEUE_SIZE_LOWER_LIMIT =  16*BUFFER_SIZE;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keywordtype">bool</span> wr_err_reported = <span class="keyword">false</span>;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector.html">std::vector&lt; uv::file &gt;</a> files;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> file_write_queues_size = 0;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<a class="code" href="classuv_1_1buffer.html">uv::buffer</a> alloc_cb(<a class="code" href="classuv_1_1handle.html">uv::handle</a>, <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a>);</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keywordtype">void</span> write_to_stdout_cb(<a class="code" href="classuv_1_1output.html">uv::output</a>, <a class="code" href="classuv_1_1buffer.html">uv::buffer</a>);</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> _argc, <span class="keywordtype">char</span> *_argv[])</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;{</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="keywordflow">if</span> (!in)</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  {</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    PRINT_UV_ERR(in.<a class="code" href="classuv_1_1handle.html#ad6e3d22a225714b3df756b539dce6ced">uv_status</a>(), <span class="stringliteral">&quot;stdin open (%s)&quot;</span>, in.<a class="code" href="classuv_1_1handle.html#a4934d105693fa4efb342713a99541a41">type_name</a>());</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="keywordflow">return</span> in.<a class="code" href="classuv_1_1handle.html#ad6e3d22a225714b3df756b539dce6ced">uv_status</a>();</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  }</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  DEBUG_LOG(<span class="keyword">true</span>, <span class="stringliteral">&quot;[debug] stdin: %s handle [0x%08tX]\n&quot;</span>, in.<a class="code" href="classuv_1_1handle.html#a4934d105693fa4efb342713a99541a41">type_name</a>(), (ptrdiff_t)static_cast&lt; ::uv_handle_t* &gt;(in));</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keywordflow">if</span> (!out)</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  {</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    PRINT_UV_ERR(out.uv_status(), <span class="stringliteral">&quot;stdout open (%s)&quot;</span>, out.type_name());</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="keywordflow">return</span> out.uv_status();</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  }</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  DEBUG_LOG(<span class="keyword">true</span>, <span class="stringliteral">&quot;[debug] stdout: %s handle [0x%08tX]\n&quot;</span>, out.type_name(), (ptrdiff_t)static_cast&lt; ::uv_handle_t* &gt;(out));</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="comment">// open files specified as the program arguments on the command line</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  constexpr <span class="keywordtype">int</span> mode = </div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="preprocessor">  #ifdef _WIN32</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;      _S_IREAD|_S_IWRITE;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="preprocessor">  #else</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;      S_IRWXU|S_IRWXG|S_IRWXO;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="preprocessor">  #endif</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; _argc; ++i)</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  {</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <a class="code" href="classuv_1_1file.html">uv::file</a> f(<a class="code" href="classuv_1_1loop.html#a465f36947090c922c69611e2a18428ea">uv::loop::Default</a>(), _argv[i], O_CREAT|O_TRUNC|O_WRONLY, mode);</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="keywordflow">if</span> (f)</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      files.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/emplace_back.html">emplace_back</a>(<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(f));</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;      PRINT_UV_ERR(f.uv_status(), <span class="stringliteral">&quot;file open (%s)&quot;</span>, f.path());</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  }</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="comment">// attach the handle to the loop for reading incoming data</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  in.<a class="code" href="classuv_1_1io.html#af0063c57172496014de6866ab019874f">read_start</a>(alloc_cb,</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;      [](<a class="code" href="classuv_1_1io.html">uv::io</a> _io, ssize_t _nread, <a class="code" href="classuv_1_1buffer.html">uv::buffer</a> _buf, int64_t _offset, <span class="keywordtype">void</span> *_info) -&gt; <span class="keywordtype">void</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;      {</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        <span class="keywordflow">if</span> (_nread &lt; 0)</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        {</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;          <span class="keywordflow">if</span> (_nread != UV_EOF)  PRINT_UV_ERR(_nread, <span class="stringliteral">&quot;read from stdin (%s)&quot;</span>, in.<a class="code" href="classuv_1_1handle.html#a4934d105693fa4efb342713a99541a41">type_name</a>());</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;          _io.<a class="code" href="classuv_1_1io.html#a5d21b4aba39a7c85636499a0167dffc4">read_stop</a>();</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        }</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_nread &gt; 0)</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        {</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;          <span class="comment">// set the actual data size</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;          _buf.<a class="code" href="classuv_1_1buffer.html#ac503c636db4682f25a2d56e0f221d110">len</a>() = _nread;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;          <span class="comment">// write to stdout</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;          <a class="code" href="classuv_1_1output.html">uv::output</a> io_wr;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;          io_wr.on_request() = write_to_stdout_cb;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;          io_wr.<a class="code" href="classuv_1_1output.html#a7344e15c8dae8a0025e5de4ace3a79ee">run</a>(out, _buf, _offset, _info);  <span class="comment">// note: UDP connected sockets are not supported by libuv</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;          <span class="keywordflow">if</span> (!io_wr)</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;          {</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            PRINT_UV_ERR(io_wr.<a class="code" href="classuv_1_1request.html#a806f9cb8d72f1395d1853dca942b57e9">uv_status</a>(), <span class="stringliteral">&quot;write initiation to stdout (%s) at offset %&quot;</span> PRIi64, out.type_name(), _offset);</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            _io.<a class="code" href="classuv_1_1io.html#a5d21b4aba39a7c85636499a0167dffc4">read_stop</a>();</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;          }</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        }</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        <span class="keyword">auto</span> total_write_pending_bytes = out.write_queue_size() + file_write_queues_size;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="keywordtype">int</span> ret = in.<a class="code" href="classuv_1_1io.html#afb2125e0c8444e1f1213cc3bf235ab2c">read_pause</a>(total_write_pending_bytes &gt;= WRITE_QUEUE_SIZE_UPPER_LIMIT);</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        DEBUG_LOG(ret == 0, <span class="stringliteral">&quot;[debug] read paused (total_write_pending_bytes=%zu)\n&quot;</span>, total_write_pending_bytes);</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;      }</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  );</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <span class="keywordflow">if</span> (!in)</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  {</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    PRINT_UV_ERR(in.<a class="code" href="classuv_1_1handle.html#ad6e3d22a225714b3df756b539dce6ced">uv_status</a>(), <span class="stringliteral">&quot;read initiation from stdin (%s)&quot;</span>, in.<a class="code" href="classuv_1_1handle.html#a4934d105693fa4efb342713a99541a41">type_name</a>());</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordflow">return</span> in.<a class="code" href="classuv_1_1handle.html#ad6e3d22a225714b3df756b539dce6ced">uv_status</a>();</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  }</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="classuv_1_1loop.html#a465f36947090c922c69611e2a18428ea">uv::loop::Default</a>().<a class="code" href="classuv_1_1loop.html#ac04fff79ce04627bb4daf455713a6e4c">run</a>(UV_RUN_DEFAULT);</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;}</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<a class="code" href="classuv_1_1buffer.html">uv::buffer</a> alloc_cb(<a class="code" href="classuv_1_1handle.html">uv::handle</a>, <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a>)</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;{</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  constexpr <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> default_size = BUFFER_SIZE;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="keyword">static</span> <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector.html">std::vector&lt; uv::buffer &gt;</a> buf_pool;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <span class="keywordflow">for</span> (<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> i = 0; i &lt; buf_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/size.html">size</a>(); ++i)  <span class="keywordflow">if</span> (buf_pool[i].nrefs() == 1)  <span class="comment">// a spare item</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  {</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;      buf_pool[i].len() = default_size;  <span class="comment">// restore the buffer capacity size</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      DEBUG_LOG(<span class="keyword">true</span>, <span class="stringliteral">&quot;[debug] buffer pool (size=%zu): spare item #%zu\n&quot;</span>, buf_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/size.html">size</a>(), i+1);</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <span class="keywordflow">return</span> buf_pool[i];</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  }</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  buf_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/emplace_back.html">emplace_back</a>(<a class="code" href="classuv_1_1buffer.html">uv::buffer</a>{ default_size });</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  DEBUG_LOG(<span class="keyword">true</span>, <span class="stringliteral">&quot;[debug] buffer pool (size=%zu): new item #%zu\n&quot;</span>, buf_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/size.html">size</a>(), buf_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/size.html">size</a>());</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <span class="keywordflow">return</span> buf_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/back.html">back</a>();</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;}</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="keywordtype">void</span> write_to_files(<a class="code" href="classuv_1_1buffer.html">uv::buffer</a>, int64_t);</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="keywordtype">void</span> write_to_stdout_cb(<a class="code" href="classuv_1_1output.html">uv::output</a> _wr, <a class="code" href="classuv_1_1buffer.html">uv::buffer</a> _buf)</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;{</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  <span class="keywordflow">if</span> (!_wr)</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  {</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="keywordflow">if</span> (!wr_err_reported)  <span class="comment">// report only the very first occurrence of the failure</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    {</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      PRINT_UV_ERR(_wr.<a class="code" href="classuv_1_1request.html#a806f9cb8d72f1395d1853dca942b57e9">uv_status</a>(), <span class="stringliteral">&quot;write to stdout (%s) at offset %&quot;</span> PRIi64, _wr.<a class="code" href="classuv_1_1output.html#a09ad717e221cb334c94e05cde53a3927">handle</a>().<a class="code" href="classuv_1_1handle.html#a4934d105693fa4efb342713a99541a41">type_name</a>(), _wr.<a class="code" href="classuv_1_1output.html#a88d0084fcc1f252bb8dd662822b2551c">offset</a>());</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;      wr_err_reported = <span class="keyword">true</span>;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    }</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    in.<a class="code" href="classuv_1_1io.html#a5d21b4aba39a7c85636499a0167dffc4">read_stop</a>();</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  }</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="keywordflow">else</span>  <span class="comment">// dispatch the data for writing to files only when it successfully has been written to stdout</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    write_to_files(_buf, _wr.<a class="code" href="classuv_1_1output.html#a88d0084fcc1f252bb8dd662822b2551c">offset</a>());</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  <span class="keyword">auto</span> total_write_pending_bytes = out.write_queue_size() + file_write_queues_size;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="keywordtype">int</span> ret = in.<a class="code" href="classuv_1_1io.html#a199ba73140416c29da48173644e717db">read_resume</a>(total_write_pending_bytes &lt;= WRITE_QUEUE_SIZE_LOWER_LIMIT);</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  DEBUG_LOG(ret == 0, <span class="stringliteral">&quot;[debug] read resumed (total_write_pending_bytes=%zu)\n&quot;</span>, total_write_pending_bytes);</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;}</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="keywordtype">void</span> write_to_file_cb(<a class="code" href="classuv_1_1fs_1_1write.html">uv::fs::write</a>, <a class="code" href="classuv_1_1buffer.html">uv::buffer</a>);</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="keywordtype">void</span> write_to_files(<a class="code" href="classuv_1_1buffer.html">uv::buffer</a> _buf, int64_t _offset)</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;{</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;file : files)</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  {</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <a class="code" href="classuv_1_1fs_1_1write.html">uv::fs::write</a> wr;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    wr.on_request() = write_to_file_cb;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    wr.<a class="code" href="classuv_1_1fs_1_1write.html#abd27c340d4951e0e6bd8884da49e6ad5">run</a>(file, _buf, _offset);</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordflow">if</span> (wr)</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      file_write_queues_size += _buf.<a class="code" href="classuv_1_1buffer.html#ac503c636db4682f25a2d56e0f221d110">len</a>();</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;      PRINT_UV_ERR(wr.<a class="code" href="classuv_1_1request.html#a806f9cb8d72f1395d1853dca942b57e9">uv_status</a>(), <span class="stringliteral">&quot;write initiation to file (%s) at offset %&quot;</span> PRIi64, file.path(), wr.<a class="code" href="classuv_1_1fs_1_1write.html#a69a751b9e04c64b22ba44857448cc3b2">offset</a>());</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  }</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;}</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="keywordtype">void</span> write_to_file_cb(<a class="code" href="classuv_1_1fs_1_1write.html">uv::fs::write</a> _wr, <a class="code" href="classuv_1_1buffer.html">uv::buffer</a> _buf)</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;{</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="keywordflow">if</span> (!_wr)</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    PRINT_UV_ERR(_wr.<a class="code" href="classuv_1_1request.html#a806f9cb8d72f1395d1853dca942b57e9">uv_status</a>(), <span class="stringliteral">&quot;write to file (%s) at offset %&quot;</span> PRIi64, _wr.<a class="code" href="classuv_1_1fs_1_1write.html#a2f32367efb4cc1d05e09d87672208042">handle</a>().<a class="code" href="classuv_1_1file.html#a6cdd5b29ab3f1111b132e869413c3bdc">path</a>(), _wr.<a class="code" href="classuv_1_1fs_1_1write.html#a69a751b9e04c64b22ba44857448cc3b2">offset</a>());</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  {</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    file_write_queues_size -= _buf.<a class="code" href="classuv_1_1buffer.html#ac503c636db4682f25a2d56e0f221d110">len</a>();</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keyword">auto</span> total_write_pending_bytes = out.write_queue_size() + file_write_queues_size;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="keywordtype">int</span> ret = in.<a class="code" href="classuv_1_1io.html#a199ba73140416c29da48173644e717db">read_resume</a>(total_write_pending_bytes &lt;= WRITE_QUEUE_SIZE_LOWER_LIMIT);</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    DEBUG_LOG(ret == 0, <span class="stringliteral">&quot;[debug] read resumed (total_write_pending_bytes=%zu)\n&quot;</span>, total_write_pending_bytes);</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  }</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;}</div><div class="ttc" id="classuv_1_1file_html"><div class="ttname"><a href="classuv_1_1file.html">uv::file</a></div><div class="ttdoc">The open file handle. </div><div class="ttdef"><b>Definition:</b> <a href="handle-fs_8hpp_source.html#l00029">handle-fs.hpp:29</a></div></div>
<div class="ttc" id="classuv_1_1fs_1_1write_html_a2f32367efb4cc1d05e09d87672208042"><div class="ttname"><a href="classuv_1_1fs_1_1write.html#a2f32367efb4cc1d05e09d87672208042">uv::fs::write::handle</a></div><div class="ttdeci">file handle() const noexcept</div><div class="ttdoc">The file which this write request has been running on. </div><div class="ttdef"><b>Definition:</b> <a href="request-fs_8hpp_source.html#l00471">request-fs.hpp:471</a></div></div>
<div class="ttc" id="classuv_1_1io_html_a199ba73140416c29da48173644e717db"><div class="ttname"><a href="classuv_1_1io.html#a199ba73140416c29da48173644e717db">uv::io::read_resume</a></div><div class="ttdeci">int read_resume(bool _trigger_condition)</div><div class="ttdoc">Resume reading data from the I/O endpoint after having been paused. </div><div class="ttdef"><b>Definition:</b> <a href="handle-io_8hpp_source.html#l00346">handle-io.hpp:346</a></div></div>
<div class="ttc" id="classuv_1_1buffer_html_ac503c636db4682f25a2d56e0f221d110"><div class="ttname"><a href="classuv_1_1buffer.html#ac503c636db4682f25a2d56e0f221d110">uv::buffer::len</a></div><div class="ttdeci">decltype(uv_t::len) &amp; len(const std::size_t _i=0) const noexcept</div><div class="ttdoc">The .len field of the _i-th buffer structure. </div><div class="ttdef"><b>Definition:</b> <a href="buffer_8hpp_source.html#l00242">buffer.hpp:242</a></div></div>
<div class="ttc" id="classuv_1_1io_html_afb2125e0c8444e1f1213cc3bf235ab2c"><div class="ttname"><a href="classuv_1_1io.html#afb2125e0c8444e1f1213cc3bf235ab2c">uv::io::read_pause</a></div><div class="ttdeci">int read_pause(bool _trigger_condition) const</div><div class="ttdoc">Pause reading data from the I/O endpoint. </div><div class="ttdef"><b>Definition:</b> <a href="handle-io_8hpp_source.html#l00289">handle-io.hpp:289</a></div></div>
<div class="ttc" id="classuv_1_1fs_1_1write_html_a69a751b9e04c64b22ba44857448cc3b2"><div class="ttname"><a href="classuv_1_1fs_1_1write.html#a69a751b9e04c64b22ba44857448cc3b2">uv::fs::write::offset</a></div><div class="ttdeci">int64_t offset() const noexcept</div><div class="ttdoc">The offset this write request has been performed at. </div><div class="ttdef"><b>Definition:</b> <a href="request-fs_8hpp_source.html#l00474">request-fs.hpp:474</a></div></div>
<div class="ttc" id="size_t_html"><div class="ttname"><a href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a></div></div>
<div class="ttc" id="classuv_1_1handle_html_ad6e3d22a225714b3df756b539dce6ced"><div class="ttname"><a href="classuv_1_1handle.html#ad6e3d22a225714b3df756b539dce6ced">uv::handle::uv_status</a></div><div class="ttdeci">int uv_status() const noexcept</div><div class="ttdoc">The status value returned by the last executed libuv API function on this handle. ...</div><div class="ttdef"><b>Definition:</b> <a href="handle-base_8hpp_source.html#l00276">handle-base.hpp:276</a></div></div>
<div class="ttc" id="classuv_1_1io_html_a5d21b4aba39a7c85636499a0167dffc4"><div class="ttname"><a href="classuv_1_1io.html#a5d21b4aba39a7c85636499a0167dffc4">uv::io::read_stop</a></div><div class="ttdeci">int read_stop() const</div><div class="ttdoc">Stop reading data from the I/O endpoint. </div><div class="ttdef"><b>Definition:</b> <a href="handle-io_8hpp_source.html#l00254">handle-io.hpp:254</a></div></div>
<div class="ttc" id="classuv_1_1handle_html"><div class="ttname"><a href="classuv_1_1handle.html">uv::handle</a></div><div class="ttdoc">The base class for the libuv handles. </div><div class="ttdef"><b>Definition:</b> <a href="handle-base_8hpp_source.html#l00033">handle-base.hpp:33</a></div></div>
<div class="ttc" id="classuv_1_1loop_html_a465f36947090c922c69611e2a18428ea"><div class="ttname"><a href="classuv_1_1loop.html#a465f36947090c922c69611e2a18428ea">uv::loop::Default</a></div><div class="ttdeci">static loop &amp; Default() noexcept</div><div class="ttdoc">Returns the initialized loop that can be used as a global default loop throughout the program...</div><div class="ttdef"><b>Definition:</b> <a href="loop_8hpp_source.html#l00220">loop.hpp:220</a></div></div>
<div class="ttc" id="classuv_1_1loop_html_ac04fff79ce04627bb4daf455713a6e4c"><div class="ttname"><a href="classuv_1_1loop.html#ac04fff79ce04627bb4daf455713a6e4c">uv::loop::run</a></div><div class="ttdeci">int run(::uv_run_mode _mode)</div><div class="ttdoc">Go into a loop and process events and their callbacks with the current thread. </div><div class="ttdef"><b>Definition:</b> <a href="loop_8hpp_source.html#l00255">loop.hpp:255</a></div></div>
<div class="ttc" id="classuv_1_1request_html_a806f9cb8d72f1395d1853dca942b57e9"><div class="ttname"><a href="classuv_1_1request.html#a806f9cb8d72f1395d1853dca942b57e9">uv::request::uv_status</a></div><div class="ttdeci">int uv_status() const noexcept</div><div class="ttdoc">The status value returned by the last executed libuv API function on this request. </div><div class="ttdef"><b>Definition:</b> <a href="request-base_8hpp_source.html#l00185">request-base.hpp:185</a></div></div>
<div class="ttc" id="classuv_1_1output_html_a7344e15c8dae8a0025e5de4ace3a79ee"><div class="ttname"><a href="classuv_1_1output.html#a7344e15c8dae8a0025e5de4ace3a79ee">uv::output::run</a></div><div class="ttdeci">int run(io &amp;_io, const buffer &amp;_buf, int64_t _offset=-1, void *_info=nullptr)</div><div class="ttdoc">Run the request with interpreting arguments as additional parameters for actual write/send request pe...</div><div class="ttdef"><b>Definition:</b> <a href="request-io_8hpp_source.html#l00152">request-io.hpp:152</a></div></div>
<div class="ttc" id="signal_html"><div class="ttname"><a href="http://en.cppreference.com/w/cpp/utility/program/signal.html">std::signal</a></div><div class="ttdeci">T signal(T... args)</div></div>
<div class="ttc" id="move_html"><div class="ttname"><a href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a></div><div class="ttdeci">T move(T... args)</div></div>
<div class="ttc" id="classuv_1_1io_html"><div class="ttname"><a href="classuv_1_1io.html">uv::io</a></div><div class="ttdoc">The base class for handles representing I/O endpoints: a file, TCP/UDP socket, pipe, TTY. </div><div class="ttdef"><b>Definition:</b> <a href="handle-io_8hpp_source.html#l00025">handle-io.hpp:25</a></div></div>
<div class="ttc" id="classuv_1_1fs_1_1write_html"><div class="ttname"><a href="classuv_1_1fs_1_1write.html">uv::fs::write</a></div><div class="ttdoc">Write data to a file. </div><div class="ttdef"><b>Definition:</b> <a href="request-fs_8hpp_source.html#l00416">request-fs.hpp:416</a></div></div>
<div class="ttc" id="classuv_1_1fs_1_1write_html_abd27c340d4951e0e6bd8884da49e6ad5"><div class="ttname"><a href="classuv_1_1fs_1_1write.html#abd27c340d4951e0e6bd8884da49e6ad5">uv::fs::write::run</a></div><div class="ttdeci">int run(file &amp;_file, const buffer &amp;_buf, int64_t _offset)</div><div class="ttdoc">Run the request. Write data to the _file from the buffers described by _buf object. </div><div class="ttdef"><b>Definition:</b> <a href="request-fs_8hpp_source.html#l00483">request-fs.hpp:483</a></div></div>
<div class="ttc" id="size_html"><div class="ttname"><a href="http://en.cppreference.com/w/cpp/container/vector/size.html">std::vector::size</a></div><div class="ttdeci">T size(T... args)</div></div>
<div class="ttc" id="vector_html"><div class="ttname"><a href="http://en.cppreference.com/w/cpp/container/vector.html">std::vector</a></div><div class="ttdoc">STL class. </div></div>
<div class="ttc" id="classuv_1_1handle_html_a4934d105693fa4efb342713a99541a41"><div class="ttname"><a href="classuv_1_1handle.html#a4934d105693fa4efb342713a99541a41">uv::handle::type_name</a></div><div class="ttdeci">const char * type_name() const noexcept</div><div class="ttdoc">A string containing the name of the handle type. </div><div class="ttdef"><b>Definition:</b> <a href="handle-base_8hpp_source.html#l00283">handle-base.hpp:283</a></div></div>
<div class="ttc" id="classuv_1_1file_html_a6cdd5b29ab3f1111b132e869413c3bdc"><div class="ttname"><a href="classuv_1_1file.html#a6cdd5b29ab3f1111b132e869413c3bdc">uv::file::path</a></div><div class="ttdeci">const char * path() const noexcept</div><div class="ttdoc">The file path. </div><div class="ttdef"><b>Definition:</b> <a href="handle-fs_8hpp_source.html#l00207">handle-fs.hpp:207</a></div></div>
<div class="ttc" id="classuv_1_1output_html_a09ad717e221cb334c94e05cde53a3927"><div class="ttname"><a href="classuv_1_1output.html#a09ad717e221cb334c94e05cde53a3927">uv::output::handle</a></div><div class="ttdeci">io handle() const noexcept</div><div class="ttdoc">The I/O endpoint handle where this output request has been taking place. </div><div class="ttdef"><b>Definition:</b> <a href="request-io_8hpp_source.html#l00115">request-io.hpp:115</a></div></div>
<div class="ttc" id="classuv_1_1buffer_html"><div class="ttname"><a href="classuv_1_1buffer.html">uv::buffer</a></div><div class="ttdoc">Encapsulates uv_buf_t data type and provides uv_buf_t[] functionality. </div><div class="ttdef"><b>Definition:</b> <a href="buffer_8hpp_source.html#l00028">buffer.hpp:28</a></div></div>
<div class="ttc" id="back_html"><div class="ttname"><a href="http://en.cppreference.com/w/cpp/container/vector/back.html">std::vector::back</a></div><div class="ttdeci">T back(T... args)</div></div>
<div class="ttc" id="classuv_1_1io_html_a5175d7718efde0459884902558816394"><div class="ttname"><a href="classuv_1_1io.html#a5175d7718efde0459884902558816394">uv::io::guess_handle</a></div><div class="ttdeci">static io guess_handle(uv::loop &amp;, ::uv_file)</div><div class="ttdoc">Create an io handle object which actual type is derived from an existing file descriptor. </div><div class="ttdef"><b>Definition:</b> <a href="handle-io_8hpp_source.html#l00408">handle-io.hpp:408</a></div></div>
<div class="ttc" id="classuv_1_1output_html_a88d0084fcc1f252bb8dd662822b2551c"><div class="ttname"><a href="classuv_1_1output.html#a88d0084fcc1f252bb8dd662822b2551c">uv::output::offset</a></div><div class="ttdeci">int64_t offset() const noexcept</div><div class="ttdoc">The offset value specified for run() call by which this output request has been set going...</div><div class="ttdef"><b>Definition:</b> <a href="request-io_8hpp_source.html#l00133">request-io.hpp:133</a></div></div>
<div class="ttc" id="classuv_1_1output_html"><div class="ttname"><a href="classuv_1_1output.html">uv::output</a></div><div class="ttdoc">Generic write/send request type for I/O endpoints (files, TCP/UDP sockets, pipes, TTYs)...</div><div class="ttdef"><b>Definition:</b> <a href="request-io_8hpp_source.html#l00031">request-io.hpp:31</a></div></div>
<div class="ttc" id="classuv_1_1io_html_af0063c57172496014de6866ab019874f"><div class="ttname"><a href="classuv_1_1io.html#af0063c57172496014de6866ab019874f">uv::io::read_start</a></div><div class="ttdeci">int read_start(std::size_t _size=0, int64_t _offset=-1) const</div><div class="ttdoc">Start reading incoming data from the I/O endpoint. </div><div class="ttdef"><b>Definition:</b> <a href="handle-io_8hpp_source.html#l00191">handle-io.hpp:191</a></div></div>
<div class="ttc" id="emplace_back_html"><div class="ttname"><a href="http://en.cppreference.com/w/cpp/container/vector/emplace_back.html">std::vector::emplace_back</a></div><div class="ttdeci">T emplace_back(T... args)</div></div>
</div><!-- fragment --><p> <br />
 Try this program with different combinations of <code>stdin</code>/<code>stdout</code> endpoints:</p>
<p><code>stdin</code>:TTY / <code>stdout</code>:TTY </p><pre class="fragment">[mike@u250 /mnt/sda3/wroot/libuv/uvcc/uvcc.git]
$ build/example/tee1 tee-test.txt
</pre><p> <br />
 <code>stdin</code>:PIPE / <code>stdout</code>:PIPE </p><pre class="fragment">[mike@u250 /mnt/sda3/wroot/libuv/uvcc/uvcc.git]
$ cat /etc/passwd | build/example/tee1 tee-test.txt | grep root
</pre><p> <br />
 <code>stdin</code>:FILE / <code>stdout</code>:FILE </p><pre class="fragment">[mike@u250 /mnt/sda3/wroot/libuv/uvcc/uvcc.git]
$ build/example/tee1 tee-test.txt &lt;/etc/passwd &gt;tee-stdout.txt
</pre><p> <br />
 <code>stdin</code>:FILE / <code>stdout</code>:SOCKET </p><pre class="fragment">[mike@u250 /mnt/sda3/wroot/libuv/uvcc/uvcc.git]
$ nc -l 127.0.0.1 54321 &amp;
[mike@u250 /mnt/sda3/wroot/libuv/uvcc/uvcc.git]
$ build/example/tee1 tee-test.txt &lt;/etc/passwd &gt;/dev/tcp/127.0.0.1/54321
</pre><p> <br />
 The same <a class="el" href="doxy_page__example_cpio.html#doxy_anchor__cpio_test">test</a> as with <em>cpio</em> example program: </p><pre class="fragment">[mike@u250 /mnt/sda3/wroot/libuv/uvcc/uvcc.git]
$ cat /dev/zero | build/example/tee1 | dd of=/dev/null iflag=fullblock bs=1M count=10000
10000+0 records in
10000+0 records out
10485760000 bytes (10 GB) copied, 38.706 s, 271 MB/s
write to stdout (pipe) at offset 10485768192: EPIPE (-32): broken pipe
[mike@u250 /mnt/sda3/wroot/libuv/uvcc/uvcc.git]
$ cat /dev/zero | build/example/tee1 | dd of=/dev/null iflag=fullblock bs=1M count=10000
write to stdout (pipe) at offset 10485776384: EPIPE (-32): broken pipe
10000+0 records in
10000+0 records out
10485760000 bytes (10 GB) copied, 38.9361 s, 269 MB/s
</pre><p>As it can be noted, <em>tee1</em> program reports a different value of bytes written to <code>stdout</code> than <em>dd</em> has read from its <code>stdin</code>. (The same issue effectively takes place in tests for <em>cpio</em> example programs.) This is because <em>tee</em>'s read/write loop is able to perform several successful writes into the pipe before having been notified the pipe is broken and the callback for a pending write operation would receive an error.</p>
<p>Using of a buffer pool does not increase the throughput performance in this case. The implemented buffer pool is intended here for illustrative purposes only, its performance is linearly degrading as long as its size is increased (by setting up <code>WRITE_QUEUE_SIZE_UPPER_LIMIT</code> to values on the order of <code>1000*FUFFER_SIZE</code>). Another example of a buffer pool is in <em>example/tee2.cpp</em>. It uses <code><a class="el" href="classuv_1_1buffer.html#a13e629a920de74612050838212671118" title="The function type of the callback called when the reference count of the buffer using within the prog...">uv::buffer::sink_cb_t</a></code> feature. Here is part from <em>tee2.cpp</em> that differs from <em>tee1.cpp</em>:  <div class="fragment"><div class="line"><span class="keyword">class </span>buffer_pool</div><div class="line">{</div><div class="line"><span class="keyword">private</span>: <span class="comment">/*data*/</span></div><div class="line">  <span class="keywordtype">bool</span> pool_destroying = <span class="keyword">false</span>;</div><div class="line">  <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> buf_size;</div><div class="line">  <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> num_total_items;</div><div class="line">  <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector.html">std::vector&lt; uv::buffer &gt;</a> spare_items_pool;</div><div class="line"></div><div class="line"><span class="keyword">public</span>: <span class="comment">/*constructors*/</span></div><div class="line">  ~buffer_pool()</div><div class="line">  {</div><div class="line">    DEBUG_LOG(<span class="keyword">true</span>, <span class="stringliteral">&quot;[debug] buffer pool destroying: spare_items=%zu total_items=%zu\n&quot;</span>, spare_items_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/size.html">size</a>(), num_total_items);</div><div class="line">    pool_destroying = <span class="keyword">true</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  buffer_pool(<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> _buffer_size, <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> _init_pool_size, <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> _init_pool_capacity)</div><div class="line">  : buf_size(_buffer_size), num_total_items(0)</div><div class="line">  {</div><div class="line">    spare_items_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/reserve.html">reserve</a>(_init_pool_capacity);</div><div class="line">    <span class="keywordflow">while</span> (_init_pool_size--)  spare_items_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/emplace_back.html">emplace_back</a>(new_item());</div><div class="line">  }</div><div class="line"></div><div class="line">  buffer_pool(<span class="keyword">const</span> buffer_pool&amp;) = <span class="keyword">delete</span>;</div><div class="line">  buffer_pool&amp; operator =(<span class="keyword">const</span> buffer_pool&amp;) = <span class="keyword">delete</span>;</div><div class="line"></div><div class="line">  buffer_pool(buffer_pool&amp;&amp;) noexcept = default;</div><div class="line">  buffer_pool&amp; operator =(buffer_pool&amp;&amp;) noexcept = default;</div><div class="line"></div><div class="line">private: <span class="comment">/*functions*/</span></div><div class="line">  <a class="code" href="namespaceuv.html">uv</a>::buffer new_item()</div><div class="line">  {</div><div class="line">    <a class="code" href="classuv_1_1buffer.html">uv::buffer</a> ret{ buf_size };</div><div class="line">    ret.sink_cb() = [<span class="keyword">this</span>](<a class="code" href="classuv_1_1buffer.html">uv::buffer</a> &amp;_buf)</div><div class="line">    {</div><div class="line">      <span class="keywordflow">if</span> (pool_destroying)  <span class="keywordflow">return</span>;  <span class="comment">// buffers, that are being destroyed on `spare_items_pool` emptying</span></div><div class="line">                                     <span class="comment">// during its destroying when executing the `buffer_pool` class&#39;</span></div><div class="line">                                     <span class="comment">// destructor, are not to be added back into `spare_items_pool`</span></div><div class="line"></div><div class="line">      _buf.<a class="code" href="classuv_1_1buffer.html#ac503c636db4682f25a2d56e0f221d110">len</a>() = buf_size;  <span class="comment">// restore buffer size</span></div><div class="line">      spare_items_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/push_back.html">push_back</a>(<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(_buf));</div><div class="line">    };</div><div class="line"></div><div class="line">    ++num_total_items;</div><div class="line">    DEBUG_LOG(<span class="keyword">true</span>, <span class="stringliteral">&quot;[debug] buffer pool: new item #%zu\n&quot;</span>, num_total_items);</div><div class="line">    <span class="keywordflow">return</span> <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(ret);</div><div class="line">  }</div><div class="line"></div><div class="line"><span class="keyword">public</span>: <span class="comment">/*interface*/</span></div><div class="line">  <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> buffer_size() const noexcept  { <span class="keywordflow">return</span> buf_size; }</div><div class="line">  <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> total_items() const noexcept  { <span class="keywordflow">return</span> num_total_items; }</div><div class="line">  <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a> spare_items() const noexcept  { <span class="keywordflow">return</span> spare_items_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/size.html">size</a>(); }</div><div class="line"></div><div class="line">  <a class="code" href="classuv_1_1buffer.html">uv::buffer</a> <span class="keyword">get</span>()</div><div class="line">  {</div><div class="line">    <span class="keywordflow">if</span> (spare_items_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/empty.html">empty</a>())</div><div class="line">      <span class="keywordflow">return</span> new_item();</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">      <a class="code" href="classuv_1_1buffer.html">uv::buffer</a> ret = <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(spare_items_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/back.html">back</a>());</div><div class="line">      spare_items_pool.<a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector/pop_back.html">pop_back</a>();</div><div class="line">      <span class="keywordflow">return</span> <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/utility/move.html">std::move</a>(ret);</div><div class="line">    }</div><div class="line">  }</div><div class="line">} buffers(</div><div class="line">    BUFFER_SIZE,</div><div class="line">    WRITE_QUEUE_SIZE_LOWER_LIMIT/BUFFER_SIZE,</div><div class="line">    WRITE_QUEUE_SIZE_UPPER_LIMIT/BUFFER_SIZE + 1</div><div class="line">);</div><div class="line"></div><div class="line"><a class="code" href="classuv_1_1buffer.html">uv::buffer</a> alloc_cb(<a class="code" href="classuv_1_1handle.html">uv::handle</a>, <a class="codeRef" doxygen="/cygdrive/d/wroot/libuv/uvcc/uvcc.git/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/types/size_t.html">std::size_t</a>)  { <span class="keywordflow">return</span> buffers.get(); }</div></div><!-- fragment --> <br />
 Test results: </p><pre class="fragment">[mike@u250 /mnt/sda3/wroot/libuv/uvcc/uvcc.git]
$ cat /dev/zero | build/example/tee2 | dd of=/dev/null iflag=fullblock bs=1M count=10000
write to stdout (pipe) at offset 10485768192: EPIPE (-32): broken pipe
10000+0 records in
10000+0 records out
10485760000 bytes (10 GB) copied, 37.9453 s, 276 MB/s
[mike@u250 /mnt/sda3/wroot/libuv/uvcc/uvcc.git]
$ cat /dev/zero | build/example/tee2 | dd of=/dev/null iflag=fullblock bs=1M count=10000
10000+0 records in
10000+0 records out
10485760000 bytes (10 GB) copied, 38.0056 s, 276 MB/s
write to stdout (pipe) at offset 10485768192: EPIPE (-32): broken pipe
</pre> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
